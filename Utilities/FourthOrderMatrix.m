%% Extrapolation matrix at third order

function[Mlin,K,S,O,D,X00] = FourthOrderMatrix(Coordinates,Momentum,t0,tf,N)

XF=zeros(4,N); %local coordinates vector at the end
X0=zeros(4,N); %local coordinates vector at beginning

for i=1:N
        XF(:,i)=[Coordinates{i}(tf,1),Momentum{i}(tf,1),Coordinates{i}(tf,2),Momentum{i}(tf,2)];
        X0(:,i)=[Coordinates{i}(t0,1),Momentum{i}(t0,1),Coordinates{i}(t0,2),Momentum{i}(t0,2)];
end

I0=linspace(1,1,size(X0(1,:),2));
%second order vector
I2=[X0(1,:).^2; X0(2,:).*X0(1,:); X0(1,:).*X0(3,:); X0(4,:).*X0(1,:); X0(2,:).^2; X0(2,:).*X0(3,:); X0(2,:).*X0(4,:); X0(3,:).^2; X0(4,:).*X0(3,:); X0(4,:).^2];
%third order vector
I3=[X0(1,:).^3; X0(2,:).*X0(1,:).^2; X0(1,:).^2.*X0(3,:); X0(4,:).*X0(1,:).^2; X0(2,:).^2.*X0(1,:); X0(2,:).*X0(1,:).*X0(3,:); X0(2,:).*X0(4,:).*X0(1,:); X0(1,:).*X0(3,:).^2; X0(4,:).*X0(1,:).*X0(3,:); X0(4,:).^2.*X0(1,:); X0(2,:).^3; X0(2,:).^2.*X0(3,:); X0(2,:).^2.*X0(4,:); X0(2,:).*X0(3,:).^2; X0(2,:).*X0(4,:).*X0(3,:); X0(2,:).*X0(4,:).^2; X0(3,:).^3; X0(4,:).*X0(3,:).^2; X0(4,:).^2.*X0(3,:); X0(4,:).^3];
%fourth order vector
I4=[X0(1,:).^4; X0(2,:).*X0(1,:).^3; X0(1,:).^3.*X0(3,:); X0(4,:).*X0(1,:).^3; X0(2,:).^2.*X0(1,:).^2; X0(2,:).*X0(1,:).^2.*X0(3,:); X0(2,:).*X0(4,:).*X0(1,:).^2; X0(1,:).^2.*X0(3,:).^2; X0(4,:).*X0(1,:).^2.*X0(3,:); X0(4,:).^2.*X0(1,:).^2; X0(2,:).^3.*X0(1,:); X0(2,:).^2.*X0(1,:).*X0(3,:); X0(2,:).^2.*X0(4,:).*X0(1,:); X0(2,:).*X0(1,:).*X0(3,:).^2; X0(2,:).*X0(4,:).*X0(1,:).*X0(3,:); X0(2,:).*X0(4,:).^2.*X0(1,:); X0(1,:).*X0(3,:).^3; X0(4,:).*X0(1,:).*X0(3,:).^2; X0(4,:).^2.*X0(1,:).*X0(3,:); X0(4,:).^3.*X0(1,:); X0(2,:).^4; X0(2,:).^3.*X0(3,:); X0(2,:).^3.*X0(4,:); X0(2,:).^2.*X0(3,:).^2; X0(2,:).^2.*X0(4,:).*X0(3,:); X0(2,:).^2.*X0(4,:).^2; X0(2,:).*X0(3,:).^3; X0(2,:).*X0(4,:).*X0(3,:).^2; X0(2,:).*X0(4,:).^2.*X0(3,:); X0(2,:).*X0(4,:).^3; X0(3,:).^4; X0(4,:).*X0(3,:).^3; X0(4,:).^2.*X0(3,:).^2; X0(4,:).^3.*X0(3,:); X0(4,:).^4];


X00=[I0;...
    X0;...
    I2;...
    I3;...
    I4...
    ];

M4=XF/X00;
K=M4(:,1);
Mlin=M4(:,2:5);
S=M4(:,1:15);
O=M4(:,1:35);
D=M4(:,1:end);
%D=1;
end